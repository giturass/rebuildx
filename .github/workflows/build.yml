name: Build & Release (latest) android arm64

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Clone xray-core
        run: |
          git clone https://github.com/XTLS/Xray-core.git xray-core
          cd xray-core
          git submodule update --init --recursive

      - name: Patch core/core.go
        run: |
          set -e
          cd xray-core
          FILE="core/core.go"

          sed -i 's/codename = ".*"/codename = "My AI Server."/g' "$FILE"
          sed -i 's/intro    = ".*"/intro    = ""/g' "$FILE"
          sed -i 's/serial.Concat("Xray /serial.Concat("Server /g' "$FILE"
          sed -i '/intro,/d' "$FILE"

      - name: Build server binary (android arm64)
        run: |
          cd xray-core
          GOOS=android \
          GOARCH=arm64 \
          CGO_ENABLED=0 \
          go build \
            -o server \
            -trimpath \
            -buildvcs=false \
            -ldflags="-s -w -buildid=" \
            -v \
            ./main

      - name: Download geoip & geosite
        run: |
          set -e
          cd xray-core

          curl -L -o geoip.dat \
            https://github.com/v2fly/geoip/releases/latest/download/geoip.dat

          curl -L -o geosite.dat \
            https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat

      - name: Package server.zip
        run: |
          set -e
          cd xray-core

          chmod +x server
          zip -9 server.zip server geoip.dat geosite.dat

      - name: Update tag latest (force)
        run: |
          set -e
          git tag -f latest
          git push -f origin latest

      - name: Clean old assets on latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          if ! gh release view latest --repo "$OWNER/$REPO" >/dev/null 2>&1; then
            echo "No existing latest release, skip cleanup."
            exit 0
          fi

          gh api "/repos/$OWNER/$REPO/releases/tags/latest" \
            --jq '.assets[] | "\(.id) \(.name)"' \
          | while read -r id name; do
              echo "Deleting asset: $name"
              gh api -X DELETE "/repos/$OWNER/$REPO/releases/assets/$id" >/dev/null
            done

      - name: Publish GitHub Release (latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          body: |
            Server (android/arm64)

            Included files:
            - server
            - geoip.dat
            - geosite.dat
          files: |
            xray-core/server.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
